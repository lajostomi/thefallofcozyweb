<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cozy Web">

    <meta charset="utf-8" />
    <title>The Fall of Cozy Web</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="globals.css" />
    <link rel="stylesheet" href="styleguide.css" />
    <link rel="stylesheet" href="style.css" />

    <style>
        /* --- GLOBAL SETUP --- */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            overflow: hidden; 
            font-family: "Inter", sans-serif;
            position: fixed; 
            touch-action: none;
            -webkit-font-smoothing: antialiased; /* Crisp text on iOS */
        }

        #game-container { 
            width: 2360px; 
            height: 1640px; 
            position: absolute; 
            
            /* Start invisible to prevent 'flash of giant content' */
            visibility: hidden; 
            opacity: 0;
            transition: opacity 0.5s ease;

            /* Start centered */
            top: 50%; 
            left: 50%; 
            
            background-color: white; 
            overflow: hidden; 
            transform-origin: center center; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); 
            
            /* PERFORMANCE OPTIMIZATIONS */
            will-change: transform;
            backface-visibility: hidden;
            perspective: 1000px;
        }

        /* Helper to show game once JS Loads */
        #game-container.loaded {
            visibility: visible;
            opacity: 1;
        }

        .game-screen { width: 100%; height: 100%; display: none; position: absolute; top: 0; left: 0; }
        .flex-center { display: flex; justify-content: center; align-items: center; }

        /* --- LOBBY & TEXT --- */
        #screen-p1 .lobby { background-color: #4AB7BA !important; width: 100%; height: 100%; display: flex; flex-direction: column; }
        #screen-p2 .lobby { background-color: #8C49B7 !important; height: 100%; }
        .lobby .text-wrapper { margin-left: -503px; width: 1295px; align-self: center; margin-top: 132px; font-size: 128px; line-height: 192px; color: black; }
        .lobby .div { margin-left: -636px; width: 1162px; align-self: center; margin-top: 103px; font-size: 42px; line-height: 63px; color: black; }
        
        .start-button { margin-left: 1650px; width: 390px; height: 390px; margin-top: 281px; border-radius: 50%; background-color: #b5d0d1; border: none; cursor: pointer; transition: opacity 0.3s; padding: 0 !important; }
        .start-button span { font-size: 85px; color: black; pointer-events: none; white-space: nowrap; }
        .player-status { position: absolute; top: 40px; left: 40px; font-family: sans-serif; color: rgba(0,0,0,0.5); font-size: 32px; font-weight: bold; text-transform: uppercase; z-index: 100; }

        /* --- STORY & ENDINGS --- */
        #screen-story { background-color: black; cursor: pointer; }
        #story-image { width: 100%; height: 100%; object-fit: contain; display: block; }
        
        .centered-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 100px; box-sizing: border-box; }
        
        /* BRIEFING */
        #screen-briefing { transition: background-color 0.3s; }
        #task-title { font-size: 100px; font-weight: bold; color: black; margin-bottom: 50px; }
        #task-instruction { font-size: 70px; color: black; max-width: 1800px; line-height: 1.4; }
        #briefing-status { margin-top: 100px; font-size: 40px; color: black; font-style: italic; opacity: 0.7; }
        
        /* WIN/LOSS */
        #screen-gameover, #screen-victory { background-color: white; }
        .big-title { font-size: 120px; font-weight: 900; }
        .sub-text { font-size: 50px; margin-top: 40px; color: #333; }
        .replay-btn { margin-top: 50px; padding: 20px 50px; font-size: 40px; cursor: pointer; }

        /* --- CHAT UI --- */
        .SENDER-chat { background-color: white; width: 100%; height: 100%; position: relative; overflow: hidden; }

        .menu-container { position: absolute; top: 0; left: 0; width: 478px; height: 150px; z-index: 20; cursor: pointer; }
        .surrender-closed { width: 100%; height: 100%; position: absolute; top: 0; left: 0; transition: opacity 0.2s; }
        .surrender-open { width: 300px; height: 120px; position: absolute; top: 15px; left: 15px; background-color: #FF0000; border-bottom-right-radius: 45px; color: white; font-size: 32px; font-weight: bold; text-transform: uppercase; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); display: none; }

        .chat-timer { position: absolute; left: 1003px; top: 36px; color: #FF0000; font-size: 48px; font-weight: 900; line-height: 72px; }
        
        .sticky-yellow { position: absolute; left: 69px; top: 252px; width: 426px; height: 426px; transform: rotate(-15deg); transform-origin: top left; box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.25); background-color: #FFECA8; z-index: 5; flex-direction: column; text-align: center; }
        
        .sticky-content { 
            font-family: 'Patrick Hand', cursive; 
            font-size: 48px; 
            color: black; 
            line-height: 1.4; 
        }
        
        .chat-messages { position: absolute; top: 150px; left: 0; width: 100%; height: 1250px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; padding: 20px 100px; box-sizing: border-box; }
        .message-entry { padding: 24px 32px; font-size: 32px; font-weight: 500; line-height: 48px; color: white; max-width: 70%; width: fit-content; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: #4AB7BA; border-radius: 24px 16px 4px 16px; }
        .msg-partner { align-self: flex-start; background: #8C49B7; border-radius: 16px 24px 16px 2px; }

        .chat-input-area { position: absolute; left: 0px; bottom: 0px; width: 100%; height: 214px; background: #D9D9D9; display: flex; align-items: center; justify-content: center; }
        .message-form { width: 1800px; display: flex; gap: 30px; align-items: center; }
        .frame-7 { flex: 1; height: 96px; background: white; border-radius: 16px; border: none; padding: 0 32px; font-size: 32px; color: black; outline: none; }
        .frame-8 { width: 150px; height: 96px; background: #A5A5A5; border-radius: 16px; border: none; font-size: 32px; font-weight: 500; color: black; cursor: pointer; }
        .frame-8:hover { background: #909090; }

        /* --- LOGIN SCREEN --- */
        #screen-login-p2 { background-color: #272727 !important; } 
        
        .login-container { width: 1421px; height: 809px; left: 370px; top: 416px; position: absolute; background: #D9D9D9; box-shadow: 0px 4px 8px 8px rgba(0, 0, 0, 0.73); border-radius: 40px; border: 1px black solid; }
        .login-input { width: 759px; height: 136px; left: 907px; position: absolute; background: white; box-shadow: inset 0px 4px 4px rgba(0, 0, 0, 0.30); border-radius: 16px; border: 1px black solid; font-size: 60px; padding: 0 20px; font-family: Inter; }
        .input-user { top: 549px; background: #e0e0e0; color: #555; }
        .input-pass { top: 753px; }
        .input-error { border: 4px solid #FF0000 !important; color: #FF0000; }

        .login-btn-wrapper { width: 759px; height: 136px; left: 907px; top: 957px; position: absolute; border: none; background: none; cursor: pointer; padding: 0; }
        .login-btn-bg { width: 100%; height: 100%; background: #A3A3A3; box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.40); border-radius: 16px; }
        .login-btn-text { width: 100%; position: absolute; top: 20px; color: black; font-size: 64px; font-family: Inter; font-weight: 500; text-align: center; }

        .login-label { position: absolute; color: black; font-size: 64px; font-family: Inter; font-weight: 500; }
        .lbl-user { left: 473px; top: 569px; }
        .lbl-pass { left: 472px; top: 773px; }
        .login-footer { left: 609px; top: 1267px; position: absolute; color: white; font-size: 40px; font-family: Inter; font-weight: 500; }
        #login-error-msg { left: 495px; top: 302px; position: absolute; color: #FF0000; font-size: 48px; font-family: Inter; font-weight: 500; line-height: 72px; display: none; }
        
        #timer-p2-login { color: #FF0000; }

        /* --- SIDEBAR BUTTONS --- */
        .sidebar-area { 
            position: absolute; 
            width: 150px; 
            height: 1643px; 
            cursor: pointer; 
            z-index: 15; 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .sidebar-area:hover { transform: scale(1.02); }
        .sidebar-area:active { transform: scale(0.98); }

        .sb-arrow {
            width: 88px; 
            height: 32px; 
            position: absolute; 
            border: 7px solid;
            transform: rotate(45deg); 
            transform-origin: top left;
            transition: transform 0.3s ease;
        }

        #btn-to-login { right: 0; top: 0; }
        #btn-to-login .sb-bg { width: 150px; height: 1643px; background: #272727; border-top-left-radius: 45px; border-bottom-left-radius: 45px; }
        #btn-to-login .sb-arrow { left: 38.63px; top: 779px; border-color: white; }
        #btn-to-login:hover .sb-arrow { transform: rotate(45deg) translate(5px, 5px); }

        #btn-to-chat { left: 150px; top: 1643px; transform: rotate(-180deg); transform-origin: top left; }
        #btn-to-chat:hover { transform: rotate(-180deg) scale(1.02); }
        #btn-to-chat .sb-bg { width: 150px; height: 1643px; background: white; border-top-left-radius: 45px; border-bottom-left-radius: 45px; }
        #btn-to-chat .sb-arrow { left: 71.77px; top: 779.15px; border-color: #272727; }
        #btn-to-chat:hover .sb-arrow { transform: rotate(45deg) translate(5px, 5px); }

        /* --- SHUTDOWN SCREEN --- */
        #screen-shutdown-p2 { background-color: #272727; }
        .shutdown-container { width: 2160px; height: 1640px; position: relative; background: #272727; overflow: hidden; }
        #red-button-trigger { cursor: pointer; transition: transform 0.1s; position: absolute; left: 0; top: 0; width: 100%; height: 100%; }

        .shutdown-btn-base { width: 783px; height: 783px; left: 716px; top: 1238px; position: absolute; transform: rotate(-90deg); transform-origin: top left; background: #A30000; box-shadow: 0px 4px 8px 8px rgba(0, 0, 0, 0.73); border-radius: 50%; pointer-events: none; }
        .shutdown-btn-top { width: 753px; height: 753px; left: 725px; top: 1148px; position: absolute; transform: rotate(-90deg); transform-origin: top left; background: #FF0000; box-shadow: inset 4px 11px 5px 23px rgba(255, 255, 255, 0.38); border-radius: 50%; pointer-events: none; transition: all 0.1s ease-out; }
        
        .btn-pressed { transform: rotate(-90deg) scale(0.9) !important; filter: brightness(0.8); }
        .shake-screen { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
            40%, 60% { transform: translate3d(8px, 0, 0); }
        }

        .shutdown-title { left: 584px; top: 183px; position: absolute; color: white; font-size: 96px; font-family: Inter; font-weight: 500; line-height: 144px; pointer-events: none; }
        .shutdown-warn { left: 687px; top: 1336px; position: absolute; color: white; font-size: 64px; font-family: Inter; font-weight: 500; line-height: 96px; pointer-events: none; transition: all 0.3s ease; }
    </style>
  </head>
  <body>

    <div id="game-container">
        <div id="screen-p1" class="game-screen">
            <main class="lobby">
                <div class="player-status">Player 1</div>
                <h1 class="text-wrapper">The Fall of Cozy Web</h1>
                <p class="div">
                    2030 the artificial intelligence developed by B.E.C. tech, KawAi took over the World. 
                    By the bots spreading misinformation, chaos broke out in society. No one could tell what 
                    was true and what was false. Two brave developers decided to pull the plug and end KawAi’s reign. 
                    They drove their way to B.E.C.’s HQ.
                </p>
                <button id="p1-start-btn" class="start-button flex-center"><span class="text-wrapper-2">START</span></button>
            </main>
        </div>
        
        <div id="screen-p2" class="game-screen">
            <main class="lobby">
                <div class="player-status">Player 2</div>
                <h1 class="text-wrapper">The Fall of Cozy Web</h1>
                <p class="div">
                    2030 the artificial intelligence developed by B.E.C. tech, KawAi took over the World. 
                    By the bots spreading misinformation, chaos broke out in society. No one could tell what 
                    was true and what was false. Two brave developers decided to pull the plug and end KawAi’s reign. 
                    They drove their way to B.E.C.’s HQ.
                </p>
                <button id="p2-start-btn" class="start-button flex-center"><span class="text-wrapper-2">START</span></button>
            </main>
        </div>

        <div id="screen-full" class="game-screen"><main class="lobby" style="background-color: #333;"><h1 class="text-wrapper" style="color: white; margin-left:0; text-align:center; width:100%;">Lobby Full</h1></main></div>
        <div id="screen-story" class="game-screen"><img id="story-image" src="" alt="Story"></div>
        
        <div id="screen-briefing" class="game-screen centered-screen">
            <div id="task-title">YOUR MISSION</div>
            <div id="task-instruction">Loading task...</div>
            <div id="briefing-status"></div>
        </div>
        
        <div id="screen-gameover" class="game-screen centered-screen">
            <div id="gameover-text" class="big-title" style="color: red;">GAME OVER</div>
            <p id="gameover-reason" class="sub-text">Mission Failed.</p>
            <button onclick="location.reload()" class="replay-btn">PLAY AGAIN</button>
        </div>
        
        <div id="screen-victory" class="game-screen centered-screen">
            <div id="victory-text" class="big-title" style="color: #4AB7BA;">MISSION ACCOMPLISHED</div><p class="sub-text">KawAi has been shut down.</p><button onclick="location.reload()" class="replay-btn">PLAY AGAIN</button>
        </div>

        <div id="screen-chat-p1" class="game-screen">
            <main class="SENDER-chat">
                <div class="menu-container" id="surrender-p1"><div class="surrender-closed"><div style="width: 150px; height: 150px; left: 0px; top: 0px; position: absolute; background: #707070; border-bottom-right-radius: 45px"></div><div style="width: 150px; height: 150px; left: 0px; top: 0px; position: absolute; background: #272727; border-bottom-right-radius: 45px"></div><div style="width: 100px; height: 103px; left: 25px; top: 23px; position: absolute; overflow: hidden"><div style="left: 20px; top: 44px; position: absolute; color: #FF0000; font-size: 14px; font-weight: 500;">surrender</div><div style="width: 56px; height: 22px; left: 43px; top: 34px; position: absolute; background: #707070"></div><div style="width: 42px; height: 22px; left: 40px; top: 0px; position: absolute; background: #707070"></div><div style="width: 33px; height: 80px; left: 0px; top: 22px; position: absolute; background: #707070"></div></div></div><div class="surrender-open flex-center">SURRENDER</div></div>
                <time id="timer-p1" class="chat-timer">05:00</time>
                <article class="sticky-yellow flex-center"><div class="sticky-content">USERNAME:<br>JOHNDOE123<br><br>PASSWORD:<br><span id="p1-pass-display" style="color: #d12e2e; font-weight: bold; letter-spacing: 2px;">LOADING...</span></div></article>
                <section id="p1-messages" class="chat-messages"></section>
                <footer class="chat-input-area"><form id="p1-form" class="message-form"><input type="text" id="p1-input" class="frame-7" placeholder="Type your message" autocomplete="off" /><button type="submit" class="frame-8">Send</button></form></footer>
            </main>
        </div>

        <div id="screen-chat-p2" class="game-screen">
            <main class="SENDER-chat">
                <div class="menu-container" id="surrender-p2"><div class="surrender-closed"><div style="width: 150px; height: 150px; left: 0px; top: 0px; position: absolute; background: #707070; border-bottom-right-radius: 45px"></div><div style="width: 150px; height: 150px; left: 0px; top: 0px; position: absolute; background: #272727; border-bottom-right-radius: 45px"></div><div style="width: 100px; height: 103px; left: 25px; top: 23px; position: absolute; overflow: hidden"><div style="left: 20px; top: 44px; position: absolute; color: #FF0000; font-size: 14px; font-weight: 500;">surrender</div><div style="width: 56px; height: 22px; left: 43px; top: 34px; position: absolute; background: #707070"></div><div style="width: 42px; height: 22px; left: 40px; top: 0px; position: absolute; background: #707070"></div><div style="width: 33px; height: 80px; left: 0px; top: 22px; position: absolute; background: #707070"></div></div></div><div class="surrender-open flex-center">SURRENDER</div></div>
                <time id="timer-p2" class="chat-timer">05:00</time>
                
                <aside id="btn-to-login" class="sidebar-area">
                    <div class="sb-bg"></div>
                    <div class="sb-arrow"></div>
                </aside>
                
                <section id="p2-messages" class="chat-messages"></section>
                <footer class="chat-input-area"><form id="p2-form" class="message-form"><input type="text" id="p2-input" class="frame-7" placeholder="Type your message" autocomplete="off" /><button type="submit" class="frame-8">Send</button></form></footer>
            </main>
        </div>

        <div id="screen-login-p2" class="game-screen">
            <div style="width: 2160px; height: 1640px; position: relative; overflow: hidden">
                <div class="login-container"></div>
                <div id="login-error-msg">incorrect credential(s) please try again (3 tries left)</div>
                <form id="login-form">
                    <input type="text" id="login-username" value="JOHNDOE123" readonly class="login-input input-user">
                    <input type="text" id="login-password" placeholder="" autocomplete="off" class="login-input input-pass">
                    <button type="submit" class="login-btn-wrapper"><div class="login-btn-bg"></div><div class="login-btn-text">LOG IN</div></button>
                </form>
                <div class="login-label lbl-user">USERNAME</div>
                <div class="login-label lbl-pass">PASSWORD</div>
                <div class="login-footer">rest assured at B.E.C.© we take care of your data</div>
                
                <div id="btn-to-chat" class="sidebar-area">
                    <div class="sb-bg"></div>
                    <div class="sb-arrow"></div>
                </div>
                
                <div id="timer-p2-login" class="chat-timer">05:00</div>
            </div>
        </div>

        <div id="screen-shutdown-p2" class="game-screen">
            <div class="shutdown-container">
                <div id="red-button-trigger">
                    <div class="shutdown-btn-base"></div>
                    <div class="shutdown-btn-top"></div>
                </div>
                <div class="shutdown-title">SERVER SHUT DOWN</div>
                <div class="shutdown-warn">don’t ever press this button!</div>
            </div>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRole = 0;
        let timerInterval = null;
        
        // Configuration
        const GAME_WIDTH = 2360;
        const GAME_HEIGHT = 1640;
        let cachedScale = 1; 
        let resizeRequestId = null;

        // --- CONTENT SETUP ---
        const storySlides = [ 'intro-01.png', 'intro-02.png', 'intro-03.png', 'intro-04.png', 'intro-05.png', 'intro-06.png', 'intro-07.png' ];
        let currentSlideIndex = 0;
        let botMessages = ["SYSTEM FAILURE", "ERROR 404", "DATA CORRUPT"];

        const els = {
            container: document.getElementById('game-container'),
            p1Pass: document.getElementById('p1-pass-display'),
            p1Messages: document.getElementById('p1-messages'),
            p2Messages: document.getElementById('p2-messages'),
            timerP1: document.getElementById('timer-p1'),
            timerP2: document.getElementById('timer-p2'),
            timerP2Login: document.getElementById('timer-p2-login'),
            loginError: document.getElementById('login-error-msg'),
            loginPassInput: document.getElementById('login-password'),
            gameoverReason: document.getElementById('gameover-reason'),
            shutdownContainer: document.querySelector('.shutdown-container'),
            screens: {
                p1: document.getElementById('screen-p1'),
                p2: document.getElementById('screen-p2'),
                full: document.getElementById('screen-full'),
                story: document.getElementById('screen-story'),
                briefing: document.getElementById('screen-briefing'),
                chatP1: document.getElementById('screen-chat-p1'),
                chatP2: document.getElementById('screen-chat-p2'),
                loginP2: document.getElementById('screen-login-p2'),
                shutdownP2: document.getElementById('screen-shutdown-p2'),
                gameover: document.getElementById('screen-gameover'),
                victory: document.getElementById('screen-victory')
            }
        };

        fetch('spam.txt').then(r => r.ok?r.text():Promise.reject()).then(t => botMessages=t.split(';').map(s=>s.trim()).filter(s=>s.length)).catch(e=>console.log("Using default spam"));

        // --- OPTIMIZED MESSENGER-STYLE RESIZE LOGIC ---
        function performLayoutUpdate() {
            // Visual Viewport logic for modern devices
            const vv = window.visualViewport;
            const windowW = window.innerWidth;
            const windowH = window.innerHeight;

            if (!vv) {
                // Fallback for ancient browsers
                const s = Math.min(windowW / GAME_WIDTH, windowH / GAME_HEIGHT);
                els.container.style.transform = `translate(-50%, -50%) scale(${s})`;
                els.container.classList.add('loaded');
                return;
            }

            // Keyboard detection: If visual height is significantly smaller than window height
            const isKeyboardOpen = vv.height < (windowH - 100);

            if (!isKeyboardOpen) {
                // Keyboard closed: Recalculate full scale
                cachedScale = Math.min(windowW / GAME_WIDTH, windowH / GAME_HEIGHT);
            }

            // Calculate offset to center the game in the visible space
            const visualCenterY = vv.offsetTop + (vv.height / 2);
            const windowCenterY = windowH / 2;
            const offsetY = visualCenterY - windowCenterY;

            // Apply Transform
            els.container.style.transform = `translate(-50%, calc(-50% + ${offsetY}px)) scale(${cachedScale})`;
            
            // Show container after first calculation
            els.container.classList.add('loaded');

            // Scroll chat to bottom if open
            if(isKeyboardOpen) {
                if(els.p1Messages) els.p1Messages.scrollTop = els.p1Messages.scrollHeight;
                if(els.p2Messages) els.p2Messages.scrollTop = els.p2Messages.scrollHeight;
            }
        }

        // Debounced/Throttled Resize
        function updateLayout() {
            if (resizeRequestId) cancelAnimationFrame(resizeRequestId);
            resizeRequestId = requestAnimationFrame(performLayoutUpdate);
        }

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', updateLayout);
            window.visualViewport.addEventListener('scroll', updateLayout);
        }
        window.addEventListener('resize', updateLayout);
        window.addEventListener('orientationchange', () => setTimeout(updateLayout, 100));

        // Initial Call
        performLayoutUpdate();

        // ---------------------------

        function showScreen(name) {
            document.querySelectorAll('.game-screen').forEach(el => el.style.display = 'none');
            if(els.screens[name]) els.screens[name].style.display = 'flex'; 
        }

        socket.on('assign_role', (role) => {
            myRole = role;
            if (role === 1) showScreen('p1');
            else if (role === 2) showScreen('p2');
            else showScreen('full');
        });

        socket.on('set_game_password', (pass) => { if(els.p1Pass) els.p1Pass.innerText = pass; });
        socket.on('start_story', () => { currentSlideIndex=0; document.getElementById('story-image').src=storySlides[0]; showScreen('story'); });
        socket.on('wait_for_partner', () => { document.getElementById('briefing-status').innerText = "Waiting for partner..."; });

        socket.on('start_task_phase', () => {
            const s = document.getElementById('briefing-status');
            s.innerText = "SYNC COMPLETE. STARTING..."; s.style.color = "green";
            setTimeout(startChatPhase, 2000);
        });

        socket.on('chat_message', (data) => {
            const html = `<article class="${(data.role===myRole)?'message-entry msg-me':'message-entry msg-partner'}">${data.text}</article>`;
            appendMessage(els.p1Messages, html); appendMessage(els.p2Messages, html);
        });

        // --- LOGIN LOGIC ---
        socket.on('login_success', () => { showScreen('shutdownP2'); });
        
        socket.on('login_error', (data) => {
            els.loginError.style.display = 'block';
            els.loginError.innerText = `incorrect credential(s) please try again (${data.attemptsLeft} tries left)`;
            els.loginPassInput.classList.add('input-error');
            els.loginPassInput.value = ""; 
        });

        // --- JUICY BUTTON ANIMATION ---
        document.getElementById('red-button-trigger').addEventListener('click', () => {
            const topPart = document.querySelector('.shutdown-btn-top');
            const warnText = document.querySelector('.shutdown-warn');
            if(topPart) {
                topPart.classList.add('btn-pressed'); 
                topPart.style.opacity = '0'; 
            }
            if(warnText) {
                warnText.innerText = ":("; 
                warnText.style.left = "1059px"; 
            }
            if(els.shutdownContainer) els.shutdownContainer.classList.add('shake-screen');
            setTimeout(() => { socket.emit('trigger_shutdown'); }, 1000); 
        });

        socket.on('game_won', () => { 
            clearInterval(timerInterval); 
            exitFullScreen(); 
            showScreen('victory'); 
        });
        
        socket.on('game_over', (data) => { 
            clearInterval(timerInterval); 
            exitFullScreen(); 
            if(data.reason) els.gameoverReason.innerText = data.reason;
            showScreen('gameover'); 
        });

        function enterFullScreen() {
            // Disable native fullscreen on iOS to prevent keyboard conflicts
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if(isIOS) return;

            const docEl = document.documentElement;
            if(docEl.requestFullscreen) docEl.requestFullscreen();
            else if(docEl.webkitRequestFullscreen) docEl.webkitRequestFullscreen(); 
            else if(docEl.msRequestFullscreen) docEl.msRequestFullscreen(); 
        }

        function exitFullScreen() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if(isIOS) return;
            
            if(document.exitFullscreen) document.exitFullscreen();
            else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
            else if(document.msExitFullscreen) document.msExitFullscreen();
        }

        function setReady(id) {
            enterFullScreen();
            const b = document.getElementById(id); 
            const t = b.querySelector('span');
            t.innerText = "WAITING..."; 
            t.style.fontSize = "32px"; 
            t.style.paddingTop = "0"; 
            b.style.opacity = "0.6"; 
            b.disabled = true;
            socket.emit('player_ready', myRole);
        }
        document.getElementById('p1-start-btn').addEventListener('click', () => setReady('p1-start-btn'));
        document.getElementById('p2-start-btn').addEventListener('click', () => setReady('p2-start-btn'));

        document.getElementById('screen-story').addEventListener('click', () => {
            currentSlideIndex++;
            if (currentSlideIndex < storySlides.length) document.getElementById('story-image').src = storySlides[currentSlideIndex];
            else {
                showScreen('briefing');
                const t = document.getElementById('task-instruction');
                const bScreen = document.getElementById('screen-briefing');
                if (myRole === 1) {
                    t.innerText = "Convey the password to your partner!";
                    bScreen.style.backgroundColor = "#4AB7BA"; 
                } else {
                    t.innerText = "Find the right password and save the World!";
                    bScreen.style.backgroundColor = "#8C49B7"; 
                }
                t.style.color = "black";
                socket.emit('story_finished', myRole);
            }
        });

        function setupChat(formId, inputId) {
            const f = document.getElementById(formId), i = document.getElementById(inputId);
            if(f) f.addEventListener('submit', (e) => { e.preventDefault(); if(i.value) { socket.emit('chat_message', { role: myRole, text: i.value }); i.value = ''; } });
        }
        setupChat('p1-form', 'p1-input'); setupChat('p2-form', 'p2-input');

        if(document.getElementById('btn-to-login')) document.getElementById('btn-to-login').addEventListener('click', () => { els.screens.chatP2.style.display='none'; els.screens.loginP2.style.display='flex'; });
        if(document.getElementById('btn-to-chat')) document.getElementById('btn-to-chat').addEventListener('click', () => { els.screens.loginP2.style.display='none'; els.screens.chatP2.style.display='flex'; });

        const lf = document.getElementById('login-form');
        if(lf) lf.addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            socket.emit('attempt_login', { username: u, password: p });
        });

        function setupSurrender(id) {
            const m = document.getElementById(id); if(!m)return;
            const c = m.querySelector('.surrender-closed'), o = m.querySelector('.surrender-open');
            c.addEventListener('click', () => { c.style.display='none'; o.style.display='flex'; });
            o.addEventListener('click', () => socket.emit('surrender', myRole));
        }
        setupSurrender('surrender-p1'); setupSurrender('surrender-p2');

        function startChatPhase() {
            els.loginError.style.display = 'none';
            els.loginPassInput.classList.remove('input-error');
            if (myRole === 1) { showScreen('chatP1'); startBotSpam(); } 
            else if (myRole === 2) { showScreen('chatP2'); }
            startTimer(5 * 60); 
        }

        function appendMessage(el, html) {
            if (!el) return;
            const nearBottom = el.scrollHeight - el.scrollTop - el.clientHeight <= 100;
            el.innerHTML += html;
            if (nearBottom) el.scrollTop = el.scrollHeight;
        }

        function startTimer(duration) {
            let t = duration;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const s = `${Math.floor(t/60).toString().padStart(2,'0')}:${(t%60).toString().padStart(2,'0')}`;
                if(els.timerP1) els.timerP1.textContent = s;
                if(els.timerP2) els.timerP2.textContent = s;
                if(els.timerP2Login) els.timerP2Login.textContent = s;
                if (--t < 0) {
                    clearInterval(timerInterval);
                    socket.emit('time_expired');
                }
            }, 1000);
        }

        function startBotSpam() {
            function loop() {
                if (els.screens.chatP1.style.display === 'none') return;
                if (botMessages.length > 0) socket.emit('chat_message', { role: 1, text: botMessages[Math.floor(Math.random() * botMessages.length)] });
                setTimeout(loop, Math.random() * 1900 + 100);
            }
            loop();
        }
    </script>
  </body>
</html>
