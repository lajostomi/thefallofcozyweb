<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cozy Web">

    <meta charset="utf-8" />
    <title>The Fall of Cozy Web</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="globals.css" />
    <link rel="stylesheet" href="styleguide.css" />
    <link rel="stylesheet" href="style.css" />

    <style>
        /* --- GLOBAL RESET & BASE --- */
        * { box-sizing: border-box; }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            overflow: hidden; 
            font-family: "Inter", sans-serif;
            position: fixed; 
            touch-action: none;
            -webkit-font-smoothing: antialiased;
        }

        /* The main container */
        #game-container { 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            background-color: white; 
            overflow: hidden; 
            
            /* Default desktop behavior (overridden by JS for desktop, CSS for mobile) */
            transform-origin: top left; 
            transition: opacity 0.5s ease;
            visibility: hidden;
            opacity: 0;
        }

        #game-container.loaded { visibility: visible; opacity: 1; }

        .game-screen { width: 100%; height: 100%; display: none; position: absolute; top: 0; left: 0; flex-direction: column; }
        .flex-center { display: flex; justify-content: center; align-items: center; }

        /* --- DESKTOP / ORIGINAL STYLES (Preserved for logic, overridden in Media Query) --- */
        /* These classes are used by the original high-res design. 
           We will override them heavily in the @media block below. */

        /* --- MOBILE OVERRIDES (The Magic) --- */
        @media screen and (max-width: 1024px) {
            
            /* Disable the JS transform logic visuals */
            #game-container {
                width: 100vw !important;
                height: 100vh !important;
                transform: none !important;
                border-radius: 0;
                box-shadow: none;
            }

            /* --- GENERIC TYPOGRAPHY --- */
            h1, .text-wrapper { font-size: 3rem !important; line-height: 1.2 !important; margin: 0 !important; width: 100% !important; text-align: center; }
            p, .div { font-size: 1.2rem !important; line-height: 1.5 !important; width: 90% !important; margin: 20px auto !important; text-align: center; }

            /* --- LOBBY --- */
            .lobby {
                padding: 20px;
                justify-content: center;
                align-items: center;
            }
            .player-status {
                top: 20px !important;
                left: 20px !important;
                font-size: 1.5rem !important;
            }
            .start-button {
                position: relative !important;
                margin: 40px auto 0 auto !important;
                width: 200px !important;
                height: 200px !important;
                left: auto !important;
                top: auto !important;
            }
            .start-button span { font-size: 40px !important; }

            /* --- STORY --- */
            #story-image { object-fit: cover !important; }

            /* --- BRIEFING/WIN/LOSS --- */
            .centered-screen { padding: 20px !important; }
            #task-title, .big-title { font-size: 3rem !important; }
            #task-instruction, .sub-text { font-size: 1.8rem !important; }
            .replay-btn { font-size: 1.5rem !important; padding: 15px 30px !important; }

            /* --- CHAT SCREENS (P1 & P2) --- */
            .SENDER-chat {
                display: flex;
                flex-direction: column;
                height: 100%;
                width: 100%;
            }

            /* Top Bar Area */
            .chat-timer {
                position: static !important;
                text-align: center;
                width: 100%;
                margin-top: 10px;
                font-size: 2rem !important;
                order: 1;
            }

            .menu-container {
                position: absolute !important;
                top: 10px !important;
                left: 10px !important;
                width: 60px !important;
                height: 60px !important;
                z-index: 100;
                transform: scale(0.5);
                transform-origin: top left;
            }

            /* Sticky Note (P1) */
            .sticky-yellow {
                position: relative !important;
                left: auto !important;
                top: auto !important;
                width: 90% !important;
                height: auto !important;
                margin: 10px auto;
                transform: rotate(-2deg) !important;
                padding: 20px;
                order: 2;
                border-radius: 5px;
            }
            .sticky-content { font-size: 1.5rem !important; }

            /* Chat Area */
            .chat-messages {
                position: relative !important;
                top: auto !important;
                left: auto !important;
                width: 100% !important;
                height: 0 !important;
                flex-grow: 1; /* Fills remaining space */
                padding: 10px !important;
                order: 3;
            }
            .message-entry {
                font-size: 1.2rem !important;
                line-height: 1.4 !important;
                padding: 15px !important;
                max-width: 85% !important;
            }

            /* Input Area */
            .chat-input-area {
                position: relative !important;
                height: auto !important;
                min-height: 80px;
                padding: 10px;
                order: 4;
            }
            .message-form {
                width: 100% !important;
                gap: 10px !important;
            }
            .frame-7 {
                height: 60px !important;
                font-size: 1.2rem !important;
                border-radius: 8px !important;
            }
            .frame-8 {
                width: 100px !important;
                height: 60px !important;
                font-size: 1.2rem !important;
                border-radius: 8px !important;
            }

            /* Navigation Sidebars (Converted to floating buttons for mobile) */
            .sidebar-area {
                width: 60px !important;
                height: 60px !important;
                position: absolute !important;
                z-index: 50;
                border-radius: 50%;
                overflow: hidden;
                box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            }
            .sidebar-area .sb-bg { width: 100% !important; height: 100% !important; border-radius: 0 !important; }
            .sidebar-area .sb-arrow { display: none; } /* Hide arrow, add icon later or keep simple */
            
            /* Specific Button Locations */
            #btn-to-login {
                right: 20px !important;
                top: 20px !important;
                left: auto !important;
                background: #272727; /* Visual indicator */
            }
            #btn-to-login::after { content: "LOGIN"; color: white; font-size: 10px; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; position: absolute; top:0; left:0; font-weight: bold;}

            #btn-to-chat {
                left: auto !important;
                right: 20px !important;
                top: 20px !important;
                transform: none !important;
                background: white;
            }
            #btn-to-chat::after { content: "CHAT"; color: black; font-size: 10px; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; position: absolute; top:0; left:0; font-weight: bold;}


            /* --- SCALED SCREENS (Login & Shutdown) --- */
            /* These screens use absolute divs to draw UI. 
               We wrap them and scale them down to fit 100vw 
            */
            #screen-login-p2 > div, 
            #screen-shutdown-p2 > .shutdown-container {
                transform-origin: top left;
                /* Calculated in JS, but default here */
                transform: scale(0.18); 
                width: 2160px; /* Original Width */
                height: 1640px; /* Original Height */
            }
            
            /* Adjustments for Login Elements */
            #login-error-msg { font-size: 4rem !important; width: 100%; text-align: center; left: 0 !important; }

            /* Ensure background covers P2 Login */
            #screen-login-p2 { overflow: hidden; }
        }
    </style>
  </head>
  <body>

    <div id="game-container">
        <div id="screen-p1" class="game-screen">
            <main class="lobby">
                <div class="player-status">Player 1</div>
                <h1 class="text-wrapper">The Fall of Cozy Web</h1>
                <p class="div">
                    2030 the artificial intelligence developed by B.E.C. tech, KawAi took over the World. 
                    Chaos broke out. Two brave developers decided to pull the plug.
                </p>
                <button id="p1-start-btn" class="start-button flex-center"><span class="text-wrapper-2">START</span></button>
            </main>
        </div>
        
        <div id="screen-p2" class="game-screen">
            <main class="lobby">
                <div class="player-status">Player 2</div>
                <h1 class="text-wrapper">The Fall of Cozy Web</h1>
                <p class="div">
                    2030 the artificial intelligence developed by B.E.C. tech, KawAi took over the World. 
                    Chaos broke out. Two brave developers decided to pull the plug.
                </p>
                <button id="p2-start-btn" class="start-button flex-center"><span class="text-wrapper-2">START</span></button>
            </main>
        </div>

        <div id="screen-full" class="game-screen"><main class="lobby" style="background-color: #333;"><h1 class="text-wrapper" style="color: white; margin-left:0; text-align:center; width:100%;">Lobby Full</h1></main></div>
        <div id="screen-story" class="game-screen"><img id="story-image" src="" alt="Story"></div>
        
        <div id="screen-briefing" class="game-screen centered-screen">
            <div id="task-title">YOUR MISSION</div>
            <div id="task-instruction">Loading task...</div>
            <div id="briefing-status"></div>
        </div>
        
        <div id="screen-gameover" class="game-screen centered-screen">
            <div id="gameover-text" class="big-title" style="color: red;">GAME OVER</div>
            <p id="gameover-reason" class="sub-text">Mission Failed.</p>
            <button onclick="location.reload()" class="replay-btn">PLAY AGAIN</button>
        </div>
        
        <div id="screen-victory" class="game-screen centered-screen">
            <div id="victory-text" class="big-title" style="color: #4AB7BA;">MISSION ACCOMPLISHED</div><p class="sub-text">KawAi has been shut down.</p><button onclick="location.reload()" class="replay-btn">PLAY AGAIN</button>
        </div>

        <div id="screen-chat-p1" class="game-screen">
            <main class="SENDER-chat">
                <div class="menu-container" id="surrender-p1"><div class="surrender-closed"><div style="width: 100%; height: 100%; position: absolute; background: #707070; border-radius: 15px;"></div><div style="width: 80%; height: 80%; left: 10%; top: 10%; position: absolute; background: #272727; border-radius: 10px;"></div><div style="color:red; font-weight:bold; position:absolute; top:35%; left:15%; font-size: 24px;">X</div></div><div class="surrender-open flex-center" style="font-size: 16px;">SURRENDER</div></div>
                
                <time id="timer-p1" class="chat-timer">05:00</time>
                
                <article class="sticky-yellow flex-center">
                    <div class="sticky-content">
                        <strong>USERNAME:</strong> JOHNDOE123<br>
                        <strong>PASSWORD:</strong> <span id="p1-pass-display" style="color: #d12e2e;">LOADING...</span>
                    </div>
                </article>
                
                <section id="p1-messages" class="chat-messages"></section>
                
                <footer class="chat-input-area">
                    <form id="p1-form" class="message-form">
                        <input type="text" id="p1-input" class="frame-7" placeholder="Type message..." autocomplete="off" />
                        <button type="submit" class="frame-8">Send</button>
                    </form>
                </footer>
            </main>
        </div>

        <div id="screen-chat-p2" class="game-screen">
            <main class="SENDER-chat">
                <div class="menu-container" id="surrender-p2"><div class="surrender-closed"><div style="width: 100%; height: 100%; position: absolute; background: #707070; border-radius: 15px;"></div><div style="width: 80%; height: 80%; left: 10%; top: 10%; position: absolute; background: #272727; border-radius: 10px;"></div><div style="color:red; font-weight:bold; position:absolute; top:35%; left:15%; font-size: 24px;">X</div></div><div class="surrender-open flex-center" style="font-size: 16px;">SURRENDER</div></div>
                
                <time id="timer-p2" class="chat-timer">05:00</time>
                
                <aside id="btn-to-login" class="sidebar-area">
                    <div class="sb-bg"></div>
                </aside>
                
                <section id="p2-messages" class="chat-messages"></section>
                
                <footer class="chat-input-area">
                    <form id="p2-form" class="message-form">
                        <input type="text" id="p2-input" class="frame-7" placeholder="Type message..." autocomplete="off" />
                        <button type="submit" class="frame-8">Send</button>
                    </form>
                </footer>
            </main>
        </div>

        <div id="screen-login-p2" class="game-screen">
            <div id="login-scaler-container" style="width: 2160px; height: 1640px; position: relative; overflow: hidden">
                <div class="login-container"></div>
                <div id="login-error-msg">incorrect credential(s) please try again (3 tries left)</div>
                <form id="login-form">
                    <input type="text" id="login-username" value="JOHNDOE123" readonly class="login-input input-user">
                    <input type="text" id="login-password" placeholder="" autocomplete="off" class="login-input input-pass">
                    <button type="submit" class="login-btn-wrapper"><div class="login-btn-bg"></div><div class="login-btn-text">LOG IN</div></button>
                </form>
                <div class="login-label lbl-user">USERNAME</div>
                <div class="login-label lbl-pass">PASSWORD</div>
                <div class="login-footer">rest assured at B.E.C.© we take care of your data</div>
                
                <div id="btn-to-chat" class="sidebar-area">
                    <div class="sb-bg"></div>
                </div>
                
                <div id="timer-p2-login" class="chat-timer">05:00</div>
            </div>
        </div>

        <div id="screen-shutdown-p2" class="game-screen">
            <div class="shutdown-container">
                <div id="red-button-trigger">
                    <div class="shutdown-btn-base"></div>
                    <div class="shutdown-btn-top"></div>
                </div>
                <div class="shutdown-title">SERVER SHUT DOWN</div>
                <div class="shutdown-warn">don’t ever press this button!</div>
            </div>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Mock socket if server not present for UI testing
        const socket = typeof io !== 'undefined' ? io() : { on:()=>{}, emit:()=>{} };
        let myRole = 0;
        let timerInterval = null;
        
        // Configuration
        const GAME_WIDTH = 2360;
        const GAME_HEIGHT = 1640;

        const els = {
            container: document.getElementById('game-container'),
            p1Pass: document.getElementById('p1-pass-display'),
            p1Messages: document.getElementById('p1-messages'),
            p2Messages: document.getElementById('p2-messages'),
            timerP1: document.getElementById('timer-p1'),
            timerP2: document.getElementById('timer-p2'),
            timerP2Login: document.getElementById('timer-p2-login'),
            loginError: document.getElementById('login-error-msg'),
            loginPassInput: document.getElementById('login-password'),
            gameoverReason: document.getElementById('gameover-reason'),
            shutdownContainer: document.querySelector('.shutdown-container'),
            loginScaler: document.getElementById('login-scaler-container'),
            screens: {
                p1: document.getElementById('screen-p1'),
                p2: document.getElementById('screen-p2'),
                full: document.getElementById('screen-full'),
                story: document.getElementById('screen-story'),
                briefing: document.getElementById('screen-briefing'),
                chatP1: document.getElementById('screen-chat-p1'),
                chatP2: document.getElementById('screen-chat-p2'),
                loginP2: document.getElementById('screen-login-p2'),
                shutdownP2: document.getElementById('screen-shutdown-p2'),
                gameover: document.getElementById('screen-gameover'),
                victory: document.getElementById('screen-victory')
            }
        };

        // --- RESPONSIVE LAYOUT ENGINE ---
        function updateLayout() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            const isMobile = w < 1024; // Threshold for mobile mode

            if (!isMobile) {
                // DESKTOP MODE: Original Aspect Ratio Scaling
                const scale = Math.min(w / GAME_WIDTH, h / GAME_HEIGHT);
                const x = (w - (GAME_WIDTH * scale)) / 2;
                const y = (h - (GAME_HEIGHT * scale)) / 2;
                
                els.container.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
                
                // Reset mobile overrides
                if(els.loginScaler) els.loginScaler.style.transform = 'none';
                if(els.shutdownContainer) els.shutdownContainer.style.transform = 'none';

            } else {
                // MOBILE MODE: CSS Handles Layout, JS Handles specific components
                
                // 1. Calculate scaling for the Fixed-Pixel-Art screens (Login & Shutdown)
                // We want to fit 2360px width into the mobile width
                const mobileScale = w / GAME_WIDTH;
                const verticalCenter = (h - (GAME_HEIGHT * mobileScale)) / 2;

                // Apply to Login
                if(els.loginScaler) {
                    els.loginScaler.style.transform = `scale(${mobileScale})`;
                    // Center it vertically if you want, or top-align
                    els.loginScaler.style.marginTop = `${verticalCenter}px`;
                }

                // Apply to Shutdown
                if(els.shutdownContainer) {
                    els.shutdownContainer.style.transform = `scale(${mobileScale})`;
                    els.shutdownContainer.style.marginTop = `${verticalCenter}px`;
                }
                
                // Chat scrolling
                if(els.p1Messages) els.p1Messages.scrollTop = els.p1Messages.scrollHeight;
                if(els.p2Messages) els.p2Messages.scrollTop = els.p2Messages.scrollHeight;
            }

            els.container.classList.add('loaded');
        }

        window.addEventListener('resize', updateLayout);
        window.addEventListener('orientationchange', () => setTimeout(updateLayout, 100));
        // Keyboard handling
        if(window.visualViewport) window.visualViewport.addEventListener('resize', updateLayout);
        
        updateLayout();

        // --- GAME LOGIC (Unchanged functionality) ---
        function showScreen(name) {
            document.querySelectorAll('.game-screen').forEach(el => el.style.display = 'none');
            if(els.screens[name]) els.screens[name].style.display = (window.innerWidth < 1024 && (name.includes('chat') || name.includes('briefing'))) ? 'flex' : (name.includes('login') ? 'block' : 'flex'); 
        }

        socket.on('assign_role', (role) => {
            myRole = role;
            if (role === 1) showScreen('p1');
            else if (role === 2) showScreen('p2');
            else showScreen('full');
        });

        // Basic event bindings for demo purposes if socket is dead
        document.getElementById('p1-start-btn').addEventListener('click', () => { showScreen('chatP1'); startTimer(300); });
        document.getElementById('p2-start-btn').addEventListener('click', () => { showScreen('chatP2'); startTimer(300); });
        
        // Navigation P2
        if(document.getElementById('btn-to-login')) document.getElementById('btn-to-login').addEventListener('click', () => { 
            els.screens.chatP2.style.display='none'; 
            els.screens.loginP2.style.display='block'; // Block for container 
            updateLayout();
        });
        if(document.getElementById('btn-to-chat')) document.getElementById('btn-to-chat').addEventListener('click', () => { 
            els.screens.loginP2.style.display='none'; 
            els.screens.chatP2.style.display='flex'; 
        });

        // Chat Form Logic
        function setupChat(formId, inputId) {
            const f = document.getElementById(formId), i = document.getElementById(inputId);
            if(f) f.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                if(i.value) { 
                    const html = `<article class="message-entry msg-me">${i.value}</article>`;
                    const target = myRole === 1 ? els.p1Messages : els.p2Messages;
                    target.innerHTML += html;
                    target.scrollTop = target.scrollHeight;
                    socket.emit('chat_message', { role: myRole, text: i.value }); 
                    i.value = ''; 
                } 
            });
        }
        setupChat('p1-form', 'p1-input'); 
        setupChat('p2-form', 'p2-input');

        // Socket listeners from original code
        socket.on('chat_message', (data) => {
            const html = `<article class="${(data.role===myRole)?'message-entry msg-me':'message-entry msg-partner'}">${data.text}</article>`;
            if(els.p1Messages) { els.p1Messages.innerHTML += html; els.p1Messages.scrollTop = els.p1Messages.scrollHeight; }
            if(els.p2Messages) { els.p2Messages.innerHTML += html; els.p2Messages.scrollTop = els.p2Messages.scrollHeight; }
        });

        function startTimer(duration) {
            let t = duration;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const s = `${Math.floor(t/60).toString().padStart(2,'0')}:${(t%60).toString().padStart(2,'0')}`;
                if(els.timerP1) els.timerP1.textContent = s;
                if(els.timerP2) els.timerP2.textContent = s;
                if(els.timerP2Login) els.timerP2Login.textContent = s;
                if (--t < 0) clearInterval(timerInterval);
            }, 1000);
        }
        
        // Shutdown Button Logic
         document.getElementById('red-button-trigger').addEventListener('click', () => {
            const topPart = document.querySelector('.shutdown-btn-top');
            const warnText = document.querySelector('.shutdown-warn');
            if(topPart) {
                topPart.classList.add('btn-pressed'); 
                topPart.style.opacity = '0'; 
            }
            if(warnText) {
                warnText.innerText = ":("; 
                // Center warning text on mobile
                if(window.innerWidth < 1024) warnText.style.left = "0";
            }
            if(els.shutdownContainer) els.shutdownContainer.classList.add('shake-screen');
            setTimeout(() => { socket.emit('trigger_shutdown'); showScreen('victory'); }, 1000); 
        });

    </script>
  </body>
</html>
